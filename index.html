<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>FW Planer LIVE</title>
    <style>
        /* --- STYLES (Unver√§ndert gut) --- */
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        :root {
            --bg-body: #ffffff; --text-main: #333; --primary: #d32f2f; --radius: 12px;
            --st-red-bg: #ffebee; --st-red-txt: #c62828; --st-red-brd: #ef9a9a;
            --st-orange-bg: #fff3e0; --st-orange-txt: #ef6c00; --st-orange-brd: #ffe082;
            --st-green-bg: #e8f5e9; --st-green-txt: #2e7d32; --st-green-brd: #a5d6a7;
            --st-gray-bg: #f3f4f6; --st-gray-txt: #9ca3af;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            margin: 0; padding: 0; background: var(--bg-body); color: var(--text-main);
            overflow-x: hidden; padding-bottom: 80px;
        }
        .screen { display: none; padding: 20px; max-width: 500px; margin: 0 auto; min-height: 100vh; }
        .active { display: block; }
        .btn { width: 100%; padding: 16px; border: none; border-radius: 12px; font-size: 1.1rem; font-weight: bold; cursor: pointer; margin-bottom: 10px; transition: transform 0.1s; }
        .btn:active { transform: scale(0.98); }
        .btn-primary { background: var(--primary); color: white; }
        .btn-outline { background: transparent; border: 2px solid #eee; color: #555; }
        .btn-text { background: none; border: none; color: #999; font-size: 0.9rem; padding: 10px; cursor: pointer; text-decoration: underline; }
        .btn-small { padding: 5px 10px; font-size: 0.8rem; width: auto; margin: 0; border: 1px solid #ddd; background: #fff; border-radius: 6px;}
        input[type="text"], input[type="password"], input[type="date"] { width: 100%; padding: 15px; margin-bottom: 15px; border: 2px solid #ddd; border-radius: 10px; font-size: 1.1rem; outline: none; background: #fff; }
        input:focus { border-color: var(--primary); }
        .user-select-list { list-style: none; padding: 0; margin: 0; }
        .user-item { background: white; border: 1px solid #eee; padding: 18px; margin-bottom: 10px; border-radius: 12px; display: flex; justify-content: space-between; align-items: center; cursor: pointer; box-shadow: 0 2px 8px rgba(0,0,0,0.03); font-size: 1.1rem; }
        .admin-card { background: #f8f9fa; padding: 20px; border-radius: 15px; margin-bottom: 20px; border: 1px solid #eee; }
        .toggle-row { display: flex; justify-content: space-between; align-items: center; padding: 10px 0; border-bottom: 1px solid #eee; font-size: 1rem; }
        .switch { position: relative; display: inline-block; width: 50px; height: 28px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 34px; }
        .slider:before { position: absolute; content: ""; height: 22px; width: 22px; left: 3px; bottom: 3px; background-color: white; transition: .4s; border-radius: 50%; box-shadow: 0 2px 4px rgba(0,0,0,0.2); }
        input:checked + .slider { background-color: var(--primary); }
        input:checked + .slider:before { transform: translateX(22px); }
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; padding-top: 10px; }
        .month-title { font-size: 1.5rem; font-weight: 800; margin: 0; }
        #reminder-banner { display: none; background: #fff3e0; border: 1px solid #ffe082; color: #e65100; padding: 15px; border-radius: 12px; margin-bottom: 20px; font-weight: bold; box-shadow: 0 4px 10px rgba(0,0,0,0.05); }
        .calendar-grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 4px; width: 100%; margin-bottom: 20px; }
        .weekday { text-align: center; font-size: 0.75rem; color: #888; font-weight: 700; margin-bottom: 5px; text-transform: uppercase; }
        .day-cell { background: white; aspect-ratio: 1 / 1; border-radius: 8px; border: 1px solid #eee; display: flex; flex-direction: column; justify-content: space-between; padding: 4px; cursor: pointer; }
        .day-num { font-size: 11px; color: #666; font-weight: 600; }
        .day-count { align-self: center; font-weight: 900; font-size: clamp(12px, 4.5vw, 18px); line-height: 1; }
        .day-check { align-self: flex-end; font-size: 10px; height: 12px; }
        .st-red { background: var(--st-red-bg); color: var(--st-red-txt); border-color: var(--st-red-brd); }
        .st-orange { background: var(--st-orange-bg); color: var(--st-orange-txt); border-color: var(--st-orange-brd); }
        .st-green { background: var(--st-green-bg); color: var(--st-green-txt); border-color: var(--st-green-brd); }
        .st-past { background: var(--st-gray-bg); color: var(--st-gray-txt); border-color: #eee; opacity: 0.5; pointer-events: none; }
        .briefing-card { background: white; border-radius: 12px; margin-top: 10px; border: 1px solid #eee; overflow: hidden; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
        .bc-head { padding: 10px 15px; font-weight: bold; display: flex; justify-content: space-between; }
        .bc-body { padding: 15px; font-size: 0.9rem; }
        .bc-green { background: var(--st-green-bg); color: var(--st-green-txt); }
        .bc-red { background: var(--st-red-bg); color: var(--st-red-txt); }
        .bc-orange { background: var(--st-orange-bg); color: var(--st-orange-txt); }
        .note-alert { background: #fff8e1; border: 1px solid #ffe082; padding: 6px 10px; border-radius: 6px; margin-top: 6px; font-size: 0.85rem;}
        .vacation-info { color: #666; font-style: italic; margin-top: 8px; font-size: 0.85rem; padding-top: 8px; border-top: 1px solid #f0f0f0; }
        .modal-bg { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 3000; display: none; align-items: center; justify-content: center; }
        .modal-card { background: white; width: 90%; max-width: 350px; padding: 20px; border-radius: 15px; box-shadow: 0 10px 30px rgba(0,0,0,0.2); }
        .user-list-scroll { max-height: 150px; overflow-y: auto; margin-bottom: 15px; font-size: 0.9rem; border-top: 1px solid #eee; padding-top: 10px;}
        
        /* Loading Overlay */
        #loading { position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(255,255,255,0.9); z-index:9999; display:flex; justify-content:center; align-items:center; flex-direction:column;}
        .loader { border: 4px solid #f3f3f3; border-top: 4px solid var(--primary); border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>

<div id="loading">
    <div class="loader"></div>
    <p style="margin-top:10px; color:#666;">Daten werden geladen...</p>
</div>

<div id="screen-user-select" class="screen active">
    <h1 style="color:var(--primary); text-align:center; margin-bottom:10px;">üöí Dienstplan</h1>
    <p style="text-align:center; color:#666; margin-bottom:30px;">Wer bist du?</p>
    
    <ul id="user-select-list" class="user-select-list"></ul>
    <div id="empty-msg" style="display:none; text-align:center; color:#999; padding:20px;">
        Verbindung hergestellt.<br>Aber noch keine Mannschaft.<br>Bitte als Admin anmelden.
    </div>

    <div style="text-align:center; margin-top:40px;">
        <button class="btn-text" onclick="showAdminLogin()">Admin Login</button>
    </div>
</div>

<div id="screen-admin-login" class="screen" style="text-align:center;">
    <h2 style="margin-top:40px;">üîí Admin Login</h2>
    <p>PIN eingeben (Standard: 112)</p>
    <input type="password" id="admin-pin" placeholder="PIN" pattern="[0-9]*" inputmode="numeric" style="text-align:center;">
    <button class="btn btn-primary" onclick="checkAdmin()">Einloggen</button>
    <button class="btn btn-outline" onclick="showStart()">Zur√ºck</button>
</div>

<div id="screen-admin-panel" class="screen">
    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
        <h2 style="margin:0">Verwaltung</h2>
        <button class="btn-small" onclick="saveAndExitAdmin()">Speichern & Ende</button>
    </div>
    
    <div class="admin-card">
        <h3 style="margin-top:0">Person anlegen</h3>
        <input type="text" id="new-name" placeholder="Nachname (z.B. M√ºller)">
        <label class="toggle-row"><span>Atemschutz (PA)</span><div class="switch"><input type="checkbox" id="new-pa"><span class="slider"></span></div></label>
        <label class="toggle-row"><span>Maschinist (C)</span><div class="switch"><input type="checkbox" id="new-c"><span class="slider"></span></div></label>
        <label class="toggle-row"><span>F√ºhrung (GF/ZF)</span><div class="switch"><input type="checkbox" id="new-gf"><span class="slider"></span></div></label>
        <button class="btn btn-primary" style="margin-top:15px;" onclick="addMember()">Hinzuf√ºgen</button>
    </div>
    <h3>Mannschaftsliste</h3>
    <ul id="admin-team-list" class="user-select-list"></ul>
</div>

<div id="screen-app" class="screen">
    <div id="reminder-banner">‚ö†Ô∏è Erinnerung: Du bist morgen eingeteilt!</div>
    <div class="header">
        <div class="month-title" id="month-display">Planer</div>
        <div style="text-align:right;">
            <div id="user-display" style="font-weight:bold;">User</div>
            <small onclick="openVacationModal()" style="color:var(--primary); cursor:pointer; margin-right:5px;">üèñÔ∏è Urlaub?</small>
            <small onclick="showStart()" style="color:#888; cursor:pointer; text-decoration:underline;">Logout</small>
        </div>
    </div>
    <div class="calendar-grid">
        <div class="weekday">Mo</div><div class="weekday">Di</div><div class="weekday">Mi</div>
        <div class="weekday">Do</div><div class="weekday">Fr</div>
        <div id="grid-content" style="display: contents;"></div>
    </div>
    <h3 style="margin:10px 0;">Aktuelle Lage</h3>
    <div id="dashboard-content"></div>
</div>

<div class="modal-bg" id="modal-bg" onclick="closeModal(event)">
    <div class="modal-card">
        <div style="font-size:1.2rem; font-weight:bold;" id="m-date">Datum</div>
        <div style="font-size:0.9rem; color:#666; margin-bottom:10px;" id="m-status-text">Status</div>
        <label style="font-size:0.8rem; font-weight:bold;">Notiz (optional):</label>
        <input type="text" id="m-note" style="margin-top:5px; padding:10px;" placeholder="z.B. erst ab 12 Uhr...">
        <div class="user-list-scroll" id="m-list"></div>
        <button class="btn btn-primary" onclick="saveEntry()">Speichern</button>
    </div>
</div>

<div class="modal-bg" id="modal-vacation" onclick="closeModal(event)">
    <div class="modal-card">
        <h3>üèñÔ∏è Urlaub melden</h3>
        <label style="font-size:0.8rem; font-weight:bold;">Von:</label><input type="date" id="vac-start">
        <label style="font-size:0.8rem; font-weight:bold;">Bis:</label><input type="date" id="vac-end">
        <button class="btn btn-primary" onclick="saveVacation()">Urlaub eintragen</button>
        <button class="btn btn-outline" onclick="document.getElementById('modal-vacation').style.display='none'">Abbrechen</button>
    </div>
</div>

<script>
    // ==========================================
    // KONFIGURATION (HIER DEINE DATEN REIN!)
    // ==========================================
    const BIN_ID = '69610ea743b1c97be9247493';  // z.B. 65a12...
    const API_KEY = '$2a$10$yjcPXqEdo.wg//cSuGU1meumRpiS6RuhElroYQmr8KXVStIkT7taa'; // z.B. $2a$10...
    // ==========================================

    let team = [];
    let entries = {};
    let vacations = [];
    
    let currentUser = null;
    let selectedKey = null;

    // --- CLOUD DATEN LADEN / SPEICHERN ---
    async function loadData() {
        document.getElementById('loading').style.display = 'flex';
        try {
            // Wenn keine ID eingetragen ist, Dummy Modus (damit man was sieht)
            if(BIN_ID.includes('HIER_')) throw new Error("No Config");

            const res = await fetch(`https://api.jsonbin.io/v3/b/${BIN_ID}/latest`, {
                headers: { 'X-Master-Key': API_KEY }
            });
            if(!res.ok) throw new Error("Netzwerkfehler");
            
            const data = await res.json();
            // JSONBin packt Daten in 'record'
            const record = data.record;
            
            team = record.team || [];
            entries = record.entries || {};
            vacations = record.vacations || [];
            
        } catch(e) {
            console.log("Offline Modus oder erste Nutzung", e);
            // Fallback auf LocalStorage wenn Cloud nicht geht
            team = JSON.parse(localStorage.getItem('fw_team')) || [];
            entries = JSON.parse(localStorage.getItem('fw_entries')) || {};
            vacations = JSON.parse(localStorage.getItem('fw_vacations')) || [];
        }
        document.getElementById('loading').style.display = 'none';
        renderUserList();
    }

    async function syncData() {
        document.getElementById('loading').style.display = 'flex';
        
        // Lokal sichern
        localStorage.setItem('fw_team', JSON.stringify(team));
        localStorage.setItem('fw_entries', JSON.stringify(entries));
        localStorage.setItem('fw_vacations', JSON.stringify(vacations));

        if(BIN_ID.includes('HIER_')) {
            setTimeout(() => document.getElementById('loading').style.display = 'none', 500);
            return;
        }

        try {
            await fetch(`https://api.jsonbin.io/v3/b/${BIN_ID}`, {
                method: 'PUT',
                headers: { 
                    'Content-Type': 'application/json',
                    'X-Master-Key': API_KEY
                },
                body: JSON.stringify({ team, entries, vacations })
            });
        } catch(e) {
            alert("Fehler beim Speichern in der Cloud. Daten nur lokal gespeichert.");
        }
        document.getElementById('loading').style.display = 'none';
    }

    // Start
    window.onload = loadData;

    // --- NAVIGATION ---
    function showScreen(id) {
        document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
        document.getElementById(id).classList.add('active');
    }
    function showStart() { currentUser = null; renderUserList(); showScreen('screen-user-select'); }

    // --- USER SELECT ---
    function renderUserList() {
        const list = document.getElementById('user-select-list');
        const emptyMsg = document.getElementById('empty-msg');
        list.innerHTML = '';
        if(team.length === 0) {
            emptyMsg.style.display = 'block';
        } else {
            emptyMsg.style.display = 'none';
            team.forEach(p => {
                let li = document.createElement('li');
                li.className = 'user-item';
                li.onclick = () => loginUser(p);
                li.innerHTML = `<span style="font-weight:600;">${p.name}</span><span class="arrow">Starten &rsaquo;</span>`;
                list.appendChild(li);
            });
        }
    }

    function loginUser(userObj) {
        currentUser = userObj;
        document.getElementById('user-display').innerText = userObj.name;
        showScreen('screen-app');
        checkReminder();
        renderCalendar();
    }

    function checkReminder() {
        const banner = document.getElementById('reminder-banner');
        banner.style.display = 'none';
        let tomorrow = new Date(); tomorrow.setDate(tomorrow.getDate() + 1);
        let key = tomorrow.toLocaleDateString('en-CA');
        let list = entries[key] || [];
        if(list.some(p => p.name === currentUser.name)) banner.style.display = 'block';
    }

    // --- ADMIN ---
    function showAdminLogin() { showScreen('screen-admin-login'); }
    function checkAdmin() {
        if(document.getElementById('admin-pin').value === '112') {
            renderAdminList(); showScreen('screen-admin-panel'); document.getElementById('admin-pin').value = '';
        } else alert('Falsche PIN!');
    }
    function renderAdminList() {
        const list = document.getElementById('admin-team-list'); list.innerHTML = '';
        team.forEach((p, index) => {
            let b = []; if(p.pa) b.push('PA'); if(p.c) b.push('C'); if(p.gf) b.push('GF');
            let li = document.createElement('li'); li.className = 'user-item'; li.style.cursor = 'default';
            li.innerHTML = `<div><b>${p.name}</b> <small>(${b.join(', ')})</small></div><button class="btn-small" style="color:red;" onclick="deleteMember(${index})">L√∂schen</button>`;
            list.appendChild(li);
        });
    }
    function addMember() {
        const name = document.getElementById('new-name').value.trim();
        if(!name) return;
        team.push({ name: name, pa: document.getElementById('new-pa').checked, c: document.getElementById('new-c').checked, gf: document.getElementById('new-gf').checked });
        document.getElementById('new-name').value = '';
        renderAdminList();
    }
    function deleteMember(i) { if(confirm('L√∂schen?')) { team.splice(i,1); renderAdminList(); } }
    
    // Admin Save
    function saveAndExitAdmin() {
        syncData(); // Ab in die Cloud
        showStart();
    }

    // --- PLANER ---
    function checkStatus(list) {
        let n = list.length;
        let pa = list.filter(x => x.pa).length;
        let c = list.filter(x => x.c).length;
        let gf = list.filter(x => x.gf).length;
        let m = [];
        if(n<6) m.push((6-n)+" Pers"); if(pa<2) m.push((2-pa)+" PA"); if(c<1) m.push("Masch."); if(gf<1) m.push("F√ºhrung");
        let col = 'green'; if(m.length>0) col = 'orange'; if(n<4) col = 'red';
        return { color: col, count: n, text: m.join(', ') || 'Vollz√§hlig' };
    }

    function renderCalendar() {
        const grid = document.getElementById('grid-content'); grid.innerHTML = '';
        const now = new Date(); now.setHours(0,0,0,0);
        document.getElementById('month-display').innerText = now.toLocaleString('de-DE', {month:'long'});
        let dayOfWeek = now.getDay(); let dist = (dayOfWeek + 6) % 7; 
        let startMonday = new Date(now); startMonday.setDate(now.getDate() - dist);

        for(let w=0; w<2; w++) {
            for(let d=0; d<5; d++) {
                let currentDay = new Date(startMonday);
                currentDay.setDate(startMonday.getDate() + (w * 7) + d);
                let key = currentDay.toLocaleDateString('en-CA');
                let list = entries[key] || [];
                let st = checkStatus(list);
                let isMe = list.some(x => x.name === currentUser.name);
                let isPast = currentDay < now;
                let el = document.createElement('div');
                let colorClass = isPast ? 'st-past' : `st-${st.color}`;
                el.className = `day-cell ${colorClass}`;
                if(!isPast) el.onclick = () => openModal(key, currentDay.getDate(), st, list);
                el.innerHTML = `<div class="day-num">${currentDay.getDate()}</div><div class="day-count">${st.count}/6</div><div class="day-check">${isMe ? '‚úÖ' : ''}</div>`;
                grid.appendChild(el);
            }
        }
        renderDashboard(now);
    }

    function openVacationModal() { document.getElementById('modal-vacation').style.display = 'flex'; }
    function saveVacation() {
        const start = document.getElementById('vac-start').value;
        const end = document.getElementById('vac-end').value;
        if(!start || !end) return alert("Datum fehlt");
        vacations.push({ name: currentUser.name, start: start, end: end });
        syncData(); // Speichern
        document.getElementById('modal-vacation').style.display = 'none';
        alert("Urlaub eingetragen!");
        renderCalendar();
    }
    function getVacationers(dateKey) { return vacations.filter(v => dateKey >= v.start && dateKey <= v.end); }

    function renderDashboard(now) {
        const board = document.getElementById('dashboard-content'); board.innerHTML = '';
        [0, 1].forEach(offset => {
            let d = new Date(now); d.setDate(now.getDate() + offset);
            if(d.getDay() === 0 || d.getDay() === 6) return; 
            let key = d.toLocaleDateString('en-CA');
            let list = entries[key] || [];
            let st = checkStatus(list);
            let title = offset === 0 ? "Heute" : "Morgen";
            let dateStr = d.toLocaleDateString('de-DE', {day:'2-digit', month:'2-digit'});
            let notesHTML = ''; list.forEach(p => { if(p.note) notesHTML += `<div class="note-alert"><b>${p.name}:</b> ${p.note}</div>`; });
            let vacationList = getVacationers(key);
            let vacHTML = ''; if(vacationList.length > 0) { let names = vacationList.map(v => v.name).join(', '); vacHTML = `<div class="vacation-info">üèñÔ∏è Im Urlaub: ${names}</div>`; }
            let msg = st.color==='green' ? '‚úÖ Einsatzbereit' : `‚ö†Ô∏è Fehlt: ${st.text}`;
            if(list.length===0) msg = "‚ö†Ô∏è Noch niemand eingeteilt";
            let card = document.createElement('div'); card.className = 'briefing-card';
            card.innerHTML = `<div class="bc-head bc-${st.color}"><span>${title}, ${dateStr}</span><span>${st.count}/6</span></div><div class="bc-body"><div style="font-weight:bold; margin-bottom:5px;">${msg}</div>${notesHTML}${vacHTML}</div>`;
            board.appendChild(card);
        });
    }

    function openModal(key, day, st, list) {
        selectedKey = key;
        document.getElementById('modal-bg').style.display = 'flex';
        document.getElementById('m-date').innerText = day + ". " + document.getElementById('month-display').innerText;
        document.getElementById('m-status-text').innerText = st.text;
        let myEntry = list.find(x => x.name === currentUser.name);
        document.getElementById('m-note').value = myEntry ? myEntry.note : '';
        let html = '';
        list.forEach(p => {
            let note = p.note ? `<br><span style="color:#d32f2f; font-size:0.8rem;">‚û• ${p.note}</span>` : '';
            html += `<div style="border-bottom:1px solid #f0f0f0; padding:4px 0;"><b>${p.name}</b> ${note}</div>`;
        });
        document.getElementById('m-list').innerHTML = html || '<i>Leer</i>';
    }

    function saveEntry() {
        let list = entries[selectedKey] || [];
        let note = document.getElementById('m-note').value;
        let idx = list.findIndex(x => x.name === currentUser.name);
        if(idx > -1) list.splice(idx, 1);
        else list.push({...currentUser, note: note});
        entries[selectedKey] = list;
        
        document.getElementById('modal-bg').style.display = 'none';
        
        syncData(); // Speichern in Cloud
        renderCalendar();
    }

    function closeModal(e) { if(e.target.id === 'modal-bg' || e.target.id === 'modal-vacation') { document.getElementById('modal-bg').style.display = 'none'; document.getElementById('modal-vacation').style.display = 'none'; }}

</script>
</body>
</html>