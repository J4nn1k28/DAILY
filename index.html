<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Tagesdienstplaner</title>

    <link rel="icon" type="image/png" href="icon.png">
    <link rel="apple-touch-icon" href="icon.png">
    <meta name="theme-color" content="#ffffff" media="(prefers-color-scheme: light)">
    <meta name="theme-color" content="#121212" media="(prefers-color-scheme: dark)">

    <style>
        /* --- GLOBAL RESET --- */
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

        /* --- FARBEN & VARS --- */
        :root {
            --primary: #d32f2f;
            --bg-body: #ffffff; --bg-card: #ffffff; --bg-input: #ffffff; --bg-admin: #f8f9fa;
            --text-main: #333333; --text-muted: #666666; --border-color: #eeeeee;
            
            --st-red-bg: #ffebee; --st-red-txt: #c62828; --st-red-brd: #ef9a9a;
            --st-org-bg: #fff3e0; --st-org-txt: #ef6c00; --st-org-brd: #ffe082;
            --st-grn-bg: #e8f5e9; --st-grn-txt: #2e7d32; --st-grn-brd: #a5d6a7;
            --st-gry-bg: #f3f4f6; --st-gry-txt: #9ca3af;

            --shadow: 0 4px 12px rgba(0,0,0,0.05);
            --radius: 12px;
        }

        @media (prefers-color-scheme: dark) {
            :root {
                --primary: #ef5350;
                --bg-body: #121212; --bg-card: #1e1e1e; --bg-input: #2c2c2c; --bg-admin: #262626;
                --text-main: #e0e0e0; --text-muted: #a0a0a0; --border-color: #333333;
                
                --st-red-bg: #450a0a; --st-red-txt: #fca5a5; --st-red-brd: #7f1d1d;
                --st-org-bg: #431407; --st-org-txt: #fdba74; --st-org-brd: #7c2d12;
                --st-grn-bg: #052e16; --st-grn-txt: #86efac; --st-grn-brd: #14532d;
                --st-gry-bg: #262626; --st-gry-txt: #555555;
                
                --shadow: 0 4px 12px rgba(0,0,0,0.3);
            }
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            margin: 0; padding: 0; background: var(--bg-body); color: var(--text-main);
            overflow-x: hidden; padding-bottom: 100px;
            transition: background 0.3s, color 0.3s;
        }

        .screen { display: none; padding: 20px; max-width: 500px; margin: 0 auto; min-height: 100vh; }
        .active { display: block; }
        
        .btn { width: 100%; padding: 16px; border: none; border-radius: 12px; font-size: 1.1rem; font-weight: bold; cursor: pointer; margin-bottom: 10px; transition: transform 0.1s; }
        .btn:active { transform: scale(0.98); }
        .btn-primary { background: var(--primary); color: white; }
        .btn-outline { background: transparent; border: 2px solid var(--border-color); color: var(--text-muted); }
        .btn-join { background: var(--st-grn-txt); color: white; }
        .btn-leave { background: var(--bg-card); border: 2px solid var(--primary); color: var(--primary); }
        .btn-text { background: none; border: none; color: var(--text-muted); font-size: 0.9rem; padding: 10px; cursor: pointer; text-decoration: underline; }
        .btn-small { padding: 5px 10px; font-size: 0.8rem; width: auto; margin: 0; border: 1px solid var(--border-color); background: var(--bg-card); color: var(--text-main); border-radius: 6px;}
        .btn-icon { background: none; border: none; font-size: 1.5rem; cursor: pointer; color: var(--primary); padding: 5px 15px; display: flex; align-items: center; justify-content: center; }

        input[type="text"], input[type="password"], input[type="date"], input[type="time"] {
            width: 100%; padding: 15px; margin-bottom: 15px; border: 2px solid var(--border-color); border-radius: 10px; 
            font-size: 1.1rem; outline: none; background: var(--bg-input); color: var(--text-main);
        }
        input:focus { border-color: var(--primary); }

        /* Time Inputs im Modal */
        .time-row { display: flex; gap: 10px; align-items: center; margin-top: 10px; display: none; }
        .radio-group { display: flex; gap: 15px; margin-bottom: 10px; }
        .radio-label { display: flex; align-items: center; gap: 5px; cursor: pointer; font-weight: 500; }

        .badge { font-size: 0.7rem; padding: 2px 5px; border-radius: 4px; margin-left: 0; margin-right: 4px; font-weight: bold; display: inline-block; }
        .badge-gf { background: var(--st-grn-bg); color: var(--st-grn-txt); }
        .badge-c { background: var(--st-org-bg); color: var(--st-org-txt); }
        .badge-pa { background: var(--st-red-bg); color: var(--st-red-txt); }
        .badge-time { border: 1px solid var(--text-muted); color: var(--text-muted); font-weight: normal; margin-left: 5px; }

        #save-bar {
            position: fixed; bottom: 0; left: 0; width: 100%;
            background: var(--bg-card); border-top: 1px solid var(--border-color);
            padding: 15px 20px; box-shadow: 0 -5px 20px rgba(0,0,0,0.1);
            display: none; justify-content: space-between; align-items: center; z-index: 2000;
            animation: slideUp 0.3s ease;
        }
        @keyframes slideUp { from {transform: translateY(100%);} to {transform: translateY(0);} }
        .save-btn-action {
            background: #2e7d32; color: white; padding: 12px 25px; 
            border-radius: 50px; font-weight: bold; border: none; font-size: 1rem; cursor: pointer;
            box-shadow: 0 4px 10px rgba(46, 125, 50, 0.3);
        }

        #user-select-list { list-style: none; padding: 0; margin: 0; display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .user-card {
            background: var(--bg-card); border: 1px solid var(--border-color); padding: 12px; 
            border-radius: 12px; cursor: pointer; box-shadow: var(--shadow);
            display: flex; flex-direction: column; align-items: flex-start; justify-content: center;
            min-height: 70px;
        }
        .user-card:active { transform: scale(0.98); background: var(--bg-admin); }
        .user-name { font-weight: 600; font-size: 1rem; margin-bottom: 5px; word-break: break-word; }

        .admin-list { list-style: none; padding: 0; margin: 0; }
        .admin-item {
            background: var(--bg-card); border: 1px solid var(--border-color); padding: 15px; margin-bottom: 8px; border-radius: 12px;
            display: flex; justify-content: space-between; align-items: center; cursor: default;
        }

        .header { display: flex; justify-content: center; align-items: center; gap: 15px; margin-bottom: 15px; padding-top: 10px; }
        .month-title { font-size: 1.4rem; font-weight: 800; margin: 0; text-align: center; min-width: 140px; }

        .calendar-grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 5px; width: 100%; margin-bottom: 20px; }
        .weekday { text-align: center; font-size: 0.75rem; color: var(--text-muted); font-weight: 700; margin-bottom: 5px; text-transform: uppercase; }
        .day-cell {
            background: var(--bg-card); aspect-ratio: 1 / 1; border-radius: 10px; border: 1px solid var(--border-color);
            display: flex; flex-direction: column; justify-content: space-between; padding: 5px; cursor: pointer;
            box-shadow: 0 2px 4px rgba(0,0,0,0.02); transition: transform 0.1s;
        }
        .day-cell:active { transform: scale(0.95); }
        .day-num { font-size: 11px; color: var(--text-muted); font-weight: 600; }
        .day-count { align-self: center; font-weight: 900; font-size: clamp(12px, 4.5vw, 18px); line-height: 1; color: var(--text-main); }
        .day-check { align-self: flex-end; font-size: 10px; height: 12px; }

        .st-red { background: var(--st-red-bg); color: var(--st-red-txt); border-color: var(--st-red-brd); }
        .st-orange { background: var(--st-org-bg); color: var(--st-org-txt); border-color: var(--st-org-brd); }
        .st-green { background: var(--st-grn-bg); color: var(--st-grn-txt); border-color: var(--st-grn-brd); }
        .st-past { background: var(--st-gry-bg); color: var(--st-gry-txt); border-color: transparent; opacity: 0.6; pointer-events: none; }

        .briefing-card { background: var(--bg-card); border-radius: 12px; margin-top: 10px; border: 1px solid var(--border-color); overflow: hidden; box-shadow: var(--shadow); position: relative; }
        .bc-head { padding: 10px 15px; font-weight: bold; display: flex; justify-content: space-between; }
        .bc-body { padding: 15px; font-size: 0.9rem; color: var(--text-main); }
        .bc-green { background: var(--st-grn-bg); color: var(--st-grn-txt); }
        .bc-red { background: var(--st-red-bg); color: var(--st-red-txt); }
        .bc-orange { background: var(--st-org-bg); color: var(--st-org-txt); }
        .note-alert { background: var(--st-org-bg); border: 1px solid var(--st-org-brd); color: var(--text-main); padding: 6px 10px; border-radius: 6px; margin-top: 6px; font-size: 0.85rem;}
        .vacation-info { color: var(--text-muted); font-style: italic; margin-top: 8px; font-size: 0.85rem; padding-top: 8px; border-top: 1px solid var(--border-color); }
        .vacation-list-item { display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid var(--border-color); font-size: 0.9rem; }
        .vacation-list-item:last-child { border-bottom: none; }
        
        .copy-btn { position: absolute; top: 8px; right: 50px; background: rgba(255,255,255,0.3); border: none; border-radius: 4px; cursor: pointer; font-size: 0.8rem; padding: 4px 8px; color: inherit; font-weight: bold; }
        .copy-btn:active { transform: scale(0.95); }

        .admin-card { background: var(--bg-admin); padding: 20px; border-radius: 15px; margin-bottom: 20px; border: 1px solid var(--border-color); }
        .toggle-row { display: flex; justify-content: space-between; align-items: center; padding: 12px 0; border-bottom: 1px solid var(--border-color); font-size: 1rem; }
        .switch { position: relative; display: inline-block; width: 50px; height: 28px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 34px; }
        .slider:before { position: absolute; content: ""; height: 22px; width: 22px; left: 3px; bottom: 3px; background-color: white; transition: .4s; border-radius: 50%; box-shadow: 0 2px 4px rgba(0,0,0,0.2); }
        input:checked + .slider { background-color: var(--primary); }
        input:checked + .slider:before { transform: translateX(22px); }

        .modal-bg { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 3000; display: none; align-items: center; justify-content: center; backdrop-filter: blur(3px); }
        .modal-card { background: var(--bg-card); width: 90%; max-width: 350px; padding: 25px; border-radius: 20px; box-shadow: 0 20px 40px rgba(0,0,0,0.4); border: 1px solid var(--border-color); color: var(--text-main); }
        .user-list-scroll { max-height: 150px; overflow-y: auto; margin-bottom: 15px; font-size: 0.9rem; border-top: 1px solid var(--border-color); padding-top: 10px;}
        
        .modal-actions { display: flex; gap: 10px; margin-top: 15px; }
        .btn-save { flex: 2; background: var(--primary); color: white; }
        .btn-delete { flex: 1; background: var(--bg-card); border: 1px solid var(--st-red-txt); color: var(--st-red-txt); }

        #loading { position:fixed; top:0; left:0; width:100%; height:100%; background:var(--bg-body); z-index:9999; display:flex; justify-content:center; align-items:center; flex-direction:column; color: var(--text-main); }
        .loader { border: 4px solid var(--border-color); border-top: 4px solid var(--primary); border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>

<div id="loading"><div class="loader"></div><p style="margin-top:10px;">Daten werden geladen...</p></div>

<div id="save-bar">
    <span style="font-weight:600; font-size:0.9rem;">‚ö†Ô∏è Ungesicherte √Ñnderungen</span>
    <button class="save-btn-action" onclick="syncData()">Speichern</button>
</div>

<div id="screen-user-select" class="screen active">
    <h1 style="color:var(--primary); text-align:center; margin-bottom:10px;">Tagesdienstplaner</h1>
    <p style="text-align:center; color:var(--text-muted); margin-bottom:20px;">Wer bist du?</p>
    <input type="text" id="user-search" placeholder="üîç Name suchen..." onkeyup="renderUserList()">
    <ul id="user-select-list"></ul>
    <div id="empty-msg" style="display:none; text-align:center; color:var(--text-muted); padding:20px;">
        Verbindung da.<br>Aber noch keine Mannschaft.<br>Bitte als Admin anmelden.
    </div>
    <div style="text-align:center; margin-top:40px; display:flex; flex-direction:column; gap:10px; align-items:center;">
        <a href="monitor.html" class="btn btn-outline" style="text-decoration:none; padding:12px 25px; border-radius:50px; font-size:1rem; border-color:var(--primary); color:var(--primary);">
            üì∫ Monitor Ansicht √∂ffnen
        </a>
        <button class="btn-text" onclick="showAdminLogin()" style="margin-top:10px;">Admin Login</button>
    </div>
</div>

<div id="screen-admin-login" class="screen" style="text-align:center;">
    <h2 style="margin-top:40px;">üîí Admin Login</h2>
    <p style="color:var(--text-muted);">PIN eingeben (Standard: 112)</p>
    <input type="password" id="admin-pin" placeholder="PIN" pattern="[0-9]*" inputmode="numeric" style="text-align:center;">
    <button class="btn btn-primary" onclick="checkAdmin()">Einloggen</button>
    <button class="btn btn-outline" onclick="showStart()">Zur√ºck</button>
</div>

<div id="screen-admin-panel" class="screen">
    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
        <h2 style="margin:0">Verwaltung</h2>
        <button class="btn-small" onclick="saveAndExitAdmin()">Ende</button>
    </div>
    <div class="admin-card">
        <h3 style="margin-top:0">Person anlegen</h3>
        <input type="text" id="new-name" placeholder="Nachname (z.B. M√ºller)">
        <label class="toggle-row"><span>Atemschutz (PA)</span><div class="switch"><input type="checkbox" id="new-pa"><span class="slider"></span></div></label>
        <label class="toggle-row"><span>Maschinist (C)</span><div class="switch"><input type="checkbox" id="new-c"><span class="slider"></span></div></label>
        <label class="toggle-row"><span>F√ºhrung (GF/ZF)</span><div class="switch"><input type="checkbox" id="new-gf"><span class="slider"></span></div></label>
        <button class="btn btn-primary" style="margin-top:15px;" onclick="addMember()">Hinzuf√ºgen</button>
    </div>
    
    <div class="admin-card" style="border-color:var(--st-red-brd); background:rgba(255,0,0,0.02);">
        <h3 style="margin-top:0; color:var(--st-red-txt);">‚ö†Ô∏è Datenpflege</h3>
        <p style="font-size:0.9rem; margin-bottom:10px;">L√∂scht Kalendereintr√§ge und Urlaube, die √§lter als 30 Tage sind.</p>
        <button class="btn btn-outline" style="border-color:var(--st-red-txt); color:var(--st-red-txt);" onclick="cleanupData()">Alte Daten l√∂schen</button>
    </div>

    <h3>Mannschaftsliste</h3>
    <ul id="admin-team-list" class="admin-list"></ul>
</div>

<div id="screen-app" class="screen">
    <div id="reminder-banner" style="display:none; background:var(--st-org-bg); border:1px solid var(--st-org-brd); color:var(--st-org-txt); padding:15px; border-radius:12px; margin-bottom:20px; font-weight:bold;">
        ‚ö†Ô∏è Erinnerung: Du bist morgen eingeteilt!
    </div>
    
    <div class="header">
        <button class="btn-icon" onclick="changeWeek(-1)">&#9664;</button>
        <div class="month-title" id="month-display">Planer</div>
        <button class="btn-icon" onclick="changeWeek(1)">&#9654;</button>
    </div>
    <div style="text-align:center; margin-bottom:10px;">
        <div id="user-display" style="font-weight:bold; display:inline-block;">User</div> |
        <small onclick="openVacationModal()" style="color:var(--primary); cursor:pointer;">üèñÔ∏è Urlaub?</small> |
        <small onclick="showStart()" style="color:var(--text-muted); cursor:pointer; text-decoration:underline;">Logout</small>
    </div>

    <div class="calendar-grid">
        <div class="weekday">Mo</div><div class="weekday">Di</div><div class="weekday">Mi</div>
        <div class="weekday">Do</div><div class="weekday">Fr</div>
        <div id="grid-content" style="display: contents;"></div>
    </div>

    <div id="vacation-list-container" style="margin-bottom:20px;"></div>

    <h3 style="margin:10px 0;">Aktuelle Lage</h3>
    <div id="dashboard-content"></div>
</div>

<div class="modal-bg" id="modal-bg" onclick="closeModal(event)">
    <div class="modal-card">
        <div style="font-size:1.2rem; font-weight:bold;" id="m-date">Datum</div>
        <div style="font-size:0.9rem; color:var(--text-muted); margin-bottom:15px;" id="m-status-text">Status</div>
        
        <div class="radio-group">
            <label class="radio-label">
                <input type="radio" name="timeType" value="full" checked onclick="toggleTimeInput(false)"> Ganzt√§gig
            </label>
            <label class="radio-label">
                <input type="radio" name="timeType" value="part" onclick="toggleTimeInput(true)"> Zeitraum
            </label>
        </div>

        <div id="time-input-container" class="time-row">
            <input type="time" id="t-start" value="06:00"> bis <input type="time" id="t-end" value="18:00">
        </div>

        <label style="font-size:0.8rem; font-weight:bold; margin-top:10px; display:block;">Notiz (optional):</label>
        <input type="text" id="m-note" style="margin-top:5px; padding:10px;" placeholder="Info...">

        <div class="user-list-scroll" id="m-list"></div>
        
        <div class="modal-actions">
            <button id="btn-delete" class="btn btn-delete" onclick="deleteEntry()" style="display:none;">Austragen</button>
            <button class="btn btn-save" onclick="saveEntry()">Speichern</button>
        </div>
    </div>
</div>

<div class="modal-bg" id="modal-vacation" onclick="closeModal(event)">
    <div class="modal-card">
        <h3>üèñÔ∏è Urlaub melden</h3>
        <label style="font-size:0.8rem; font-weight:bold;">Von:</label><input type="date" id="vac-start">
        <label style="font-size:0.8rem; font-weight:bold;">Bis:</label><input type="date" id="vac-end">
        <button class="btn btn-primary" onclick="saveVacation()">Urlaub vormerken</button>
        <button class="btn btn-outline" onclick="document.getElementById('modal-vacation').style.display='none'">Abbrechen</button>
    </div>
</div>

<script>
    // ==========================================
    // CONFIG
    // ==========================================
    const PANTRY_ID = '647f62dc-1b66-48f1-a23c-976d635d236f';  // z.B. 945e-.....
    const BASKET_NAME = 'feuerwehr_data'; // Muss mit dem Basket-Namen √ºbereinstimmen
    // ==========================================

    let team = [];
    let entries = {};
    let vacations = [];
    let currentUser = null;
    let selectedKey = null;
    let hasUnsavedChanges = false;
    let weekOffset = 0;

    // --- DATA ---
    async function loadData() {
        document.getElementById('loading').style.display = 'flex';
        try {
            if(PANTRY_ID.includes('HIER_')) throw new Error("No Config");
            const res = await fetch(`https://getpantry.cloud/apiv1/pantry/${PANTRY_ID}/basket/${BASKET_NAME}`);
            if(!res.ok) throw new Error("Netz");
            const data = await res.json();
            team = data.team || []; entries = data.entries || {}; vacations = data.vacations || [];
        } catch(e) {
            team = JSON.parse(localStorage.getItem('fw_team')) || [];
            entries = JSON.parse(localStorage.getItem('fw_entries')) || {};
            vacations = JSON.parse(localStorage.getItem('fw_vacations')) || [];
        }
        document.getElementById('loading').style.display = 'none';
        renderUserList();
    }

    async function syncData() {
        document.getElementById('loading').style.display = 'flex';
        localStorage.setItem('fw_team', JSON.stringify(team));
        localStorage.setItem('fw_entries', JSON.stringify(entries));
        localStorage.setItem('fw_vacations', JSON.stringify(vacations));
        if(!PANTRY_ID.includes('HIER_')) {
            try {
                await fetch(`https://getpantry.cloud/apiv1/pantry/${PANTRY_ID}/basket/${BASKET_NAME}`, {
                    method: 'POST', headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ team, entries, vacations })
                });
                hasUnsavedChanges = false;
                document.getElementById('save-bar').style.display = 'none';
            } catch(e) { alert("Cloud Fehler - Lokal"); }
        }
        document.getElementById('loading').style.display = 'none';
    }

    function cleanupData() {
        if(!confirm("Wirklich alte Eintr√§ge (√§lter als 30 Tage) l√∂schen?")) return;
        let cutoff = new Date(); cutoff.setDate(cutoff.getDate() - 30);
        let cutoffStr = cutoff.toLocaleDateString('en-CA');
        let delCount = 0;
        for(let k in entries) { if(k < cutoffStr) { delete entries[k]; delCount++; } }
        let initialVac = vacations.length;
        vacations = vacations.filter(v => v.end >= cutoffStr);
        delCount += (initialVac - vacations.length);
        alert(`${delCount} alte Datens√§tze entfernt.`);
        markUnsaved();
    }

    function markUnsaved() { hasUnsavedChanges = true; document.getElementById('save-bar').style.display = 'flex'; }
    window.addEventListener("beforeunload", function (e) { if (hasUnsavedChanges) { e.preventDefault(); e.returnValue = ""; }});
    window.onload = loadData;

    // --- NAV ---
    function showScreen(id) { document.querySelectorAll('.screen').forEach(s => s.classList.remove('active')); document.getElementById(id).classList.add('active'); }
    function showStart() { 
        if(hasUnsavedChanges) { if(!confirm("Ungespeichert! Abmelden?")) return; hasUnsavedChanges = false; document.getElementById('save-bar').style.display='none'; }
        currentUser = null; weekOffset=0; renderUserList(); showScreen('screen-user-select'); 
    }

    // --- USER ---
    function renderUserList() {
        const list = document.getElementById('user-select-list');
        const emptyMsg = document.getElementById('empty-msg');
        const searchVal = document.getElementById('user-search').value.toLowerCase();
        list.innerHTML = '';
        if(team.length === 0) { emptyMsg.style.display = 'block'; document.getElementById('user-search').style.display = 'none'; }
        else {
            emptyMsg.style.display = 'none'; document.getElementById('user-search').style.display = 'block';
            let sorted = [...team].sort((a,b) => a.name.localeCompare(b.name));
            let filtered = sorted.filter(p => p.name.toLowerCase().includes(searchVal));
            if(filtered.length === 0) list.innerHTML = '<li style="text-align:center;color:gray;padding:20px;grid-column:span 2;">Kein Treffer</li>';
            filtered.forEach(p => {
                let badges = [];
                if(p.gf) badges.push('<span class="badge badge-gf">GF</span>');
                if(p.c) badges.push('<span class="badge badge-c">C</span>');
                if(p.pa) badges.push('<span class="badge badge-pa">PA</span>');
                let li = document.createElement('li'); li.className = 'user-card'; li.onclick = () => loginUser(p);
                li.innerHTML = `<span class="user-name">${p.name}</span><div>${badges.join('')}</div>`;
                list.appendChild(li);
            });
        }
    }
    function loginUser(p) { currentUser = p; document.getElementById('user-display').innerText = p.name; showScreen('screen-app'); checkReminder(); renderCalendar(); }
    function checkReminder() {
        const banner = document.getElementById('reminder-banner'); banner.style.display = 'none';
        let tmr = new Date(); tmr.setDate(tmr.getDate()+1);
        let key = tmr.toLocaleDateString('en-CA');
        if((entries[key]||[]).some(p => p.name===currentUser.name)) banner.style.display='block';
    }

    // --- ADMIN ---
    function showAdminLogin() { showScreen('screen-admin-login'); }
    function checkAdmin() { if(document.getElementById('admin-pin').value==='112') { renderAdminList(); showScreen('screen-admin-panel'); document.getElementById('admin-pin').value=''; } else alert('Falsche PIN!'); }
    function renderAdminList() {
        const list = document.getElementById('admin-team-list'); list.innerHTML = '';
        let sorted = [...team].sort((a,b) => a.name.localeCompare(b.name));
        sorted.forEach((p) => {
             let realIdx = team.findIndex(t => t.name === p.name);
             let b = []; if(p.pa) b.push('PA'); if(p.c) b.push('C'); if(p.gf) b.push('GF');
             let li = document.createElement('li'); li.className='admin-item';
             li.innerHTML = `<div><b>${p.name}</b> <small>(${b.join(', ')})</small></div><button class="btn-small" style="color:var(--st-red-txt);" onclick="deleteMember(${realIdx})">L√∂schen</button>`;
             list.appendChild(li);
        });
    }
    function addMember() {
        const n = document.getElementById('new-name').value.trim(); if(!n) return;
        team.push({ name:n, pa:document.getElementById('new-pa').checked, c:document.getElementById('new-c').checked, gf:document.getElementById('new-gf').checked });
        document.getElementById('new-name').value=''; renderAdminList(); markUnsaved();
    }
    function deleteMember(i) { if(confirm('L√∂schen?')) { team.splice(i,1); renderAdminList(); markUnsaved(); } }
    function saveAndExitAdmin() { syncData(); showStart(); }

    // --- NEW LOGIC: TIME BASED CHECK ---
    function checkStatus(list) {
        // Tagesschicht Definition
        const START_HOUR = 6;
        const END_HOUR = 15;
        
        let badHours = []; // Stunden, die nicht voll sind

        // Jede Stunde pr√ºfen
        for(let h = START_HOUR; h < END_HOUR; h++) {
            // Wer ist in Stunde h da?
            // Legacy Support: Wenn kein start/end da ist, nehmen wir an er ist voll da (06-18)
            let peopleAtHour = list.filter(p => {
                let s = p.start ? parseInt(p.start.split(':')[0]) : START_HOUR;
                let e = p.end ? parseInt(p.end.split(':')[0]) : END_HOUR;
                return h >= s && h < e;
            });

            // Z√§hlen
            let n = peopleAtHour.length;
            let gf = peopleAtHour.filter(x => x.gf).length;
            let c = peopleAtHour.filter(x => x.c).length;
            
            // Checks
            let issues = [];
            if(n < 6) issues.push("Personal");
            if(gf < 1) issues.push("GF");
            if(c < 1) issues.push("Maschinist");

            if(issues.length > 0) {
                badHours.push(`${h}-${h+1} Uhr (${issues.join(', ')})`);
            }
        }

        // Ergebnis zusammenfassen
        let totalCount = list.length; // F√ºr die Anzeige oben rechts nehmen wir die Gesamtliste
        
        if (badHours.length === 0) {
            return { color: 'green', count: totalCount, text: 'Voll besetzt (06-18)' };
        } else {
            // Zeige nur den ersten Fehler an, sonst wird es zu lang
            let txt = badHours.length === (END_HOUR - START_HOUR) ? "Nicht besetzt" : "L√ºcken: " + badHours[0];
            if(badHours.length > 1) txt += " + weitere";
            
            let col = totalCount < 4 ? 'red' : 'orange';
            return { color: col, count: totalCount, text: txt };
        }
    }

    function changeWeek(dir) { weekOffset += dir; renderCalendar(); }

    function renderCalendar() {
        const grid = document.getElementById('grid-content'); grid.innerHTML = '';
        const now = new Date(); now.setHours(0,0,0,0);
        
        let dayOfWeek = now.getDay(); let dist = (dayOfWeek + 6) % 7; 
        let startMonday = new Date(now); 
        startMonday.setDate(now.getDate() - dist + (weekOffset * 7)); 

        document.getElementById('month-display').innerText = startMonday.toLocaleString('de-DE', {month:'long', year:'2-digit'});

        for(let w=0; w<2; w++) { 
            for(let d=0; d<5; d++) {
                let currentDay = new Date(startMonday);
                currentDay.setDate(startMonday.getDate() + (w * 7) + d);
                let key = currentDay.toLocaleDateString('en-CA');
                let list = entries[key] || [];
                let st = checkStatus(list);
                let isMe = list.some(x => x.name === currentUser.name);
                let isPast = currentDay < now;
                let el = document.createElement('div');
                let colorClass = isPast ? 'st-past' : `st-${st.color}`;
                el.className = `day-cell ${colorClass}`;
                if(!isPast) el.onclick = () => openModal(key, currentDay.getDate(), st, list);
                el.innerHTML = `<div class="day-num">${currentDay.getDate()}</div><div class="day-count">${st.count}/6</div><div class="day-check">${isMe ? '‚úÖ' : ''}</div>`;
                grid.appendChild(el);
            }
        }
        renderVacationList(startMonday);
        renderDashboard(now);
    }

    function renderVacationList(startMonday) {
        const container = document.getElementById('vacation-list-container');
        let viewEnd = new Date(startMonday); viewEnd.setDate(viewEnd.getDate() + 13); 
        let activeVacations = vacations.filter(v => {
            let vStart = new Date(v.start); let vEnd = new Date(v.end);
            return vStart <= viewEnd && vEnd >= startMonday;
        }).sort((a, b) => new Date(a.start) - new Date(b.start));

        if (activeVacations.length === 0) { container.innerHTML = ''; return; }

        let html = '<h3 style="margin:10px 0;">üèñÔ∏è Geplante Abwesenheiten</h3><div class="briefing-card"><div class="bc-body" style="padding:5px 15px;">';
        activeVacations.forEach(v => {
            let sDate = new Date(v.start).toLocaleDateString('de-DE', {day:'2-digit', month:'2-digit'});
            let eDate = new Date(v.end).toLocaleDateString('de-DE', {day:'2-digit', month:'2-digit'});
            html += `<div class="vacation-list-item"><b>${v.name}</b> <span>${sDate} - ${eDate}</span></div>`;
        });
        html += '</div></div>';
        container.innerHTML = html;
    }

    function openVacationModal() { document.getElementById('modal-vacation').style.display='flex'; }
    function saveVacation() {
        let s = document.getElementById('vac-start').value, e = document.getElementById('vac-end').value;
        if(!s || !e) return alert("Datum fehlt");
        vacations.push({ name: currentUser.name, start: s, end: e });
        document.getElementById('modal-vacation').style.display='none'; renderCalendar(); markUnsaved();
    }
    function getVacationers(key) { return vacations.filter(v => key >= v.start && key <= v.end); }
    
    function copyStatus(key, title, st, list) {
        let names = list.map(p => {
            let t = (p.start && p.end && (p.start!=='06:00' || p.end!=='18:00')) ? ` (${p.start}-${p.end})` : '';
            return p.name + t;
        }).join(', ');
        
        let missing = st.color === 'green' ? "Einsatzbereit" : "‚ö†Ô∏è Problem: " + st.text;
        let text = `*Status ${title} (${key.split('-').reverse().join('.')})*\n${missing}\n\nüë• Dabei (${st.count}/6): ${names || '-'}`;
        navigator.clipboard.writeText(text).then(() => alert("Kopiert! Ab in WhatsApp damit.")).catch(e => alert("Fehler beim Kopieren"));
    }

    function renderDashboard(now) {
        const board = document.getElementById('dashboard-content'); board.innerHTML = '';
        [0, 1].forEach(offset => {
            let d = new Date(now); d.setDate(now.getDate() + offset);
            if(d.getDay() === 0 || d.getDay() === 6) return; 
            let key = d.toLocaleDateString('en-CA');
            let list = entries[key] || [];
            let st = checkStatus(list);
            let title = offset === 0 ? "Heute" : "Morgen";
            let dateStr = d.toLocaleDateString('de-DE', {day:'2-digit', month:'2-digit'});
            
            // Notes + Times
            let notesHTML = ''; 
            list.forEach(p => { 
                let t = (p.start && p.end && (p.start!=='06:00' || p.end!=='18:00')) ? ` üïí ${p.start}-${p.end}` : '';
                if(p.note || t) notesHTML += `<div class="note-alert"><b>${p.name}:</b> ${t} ${p.note}</div>`; 
            });
            
            let vacationList = getVacationers(key);
            let vacHTML = ''; if(vacationList.length > 0) { let names = vacationList.map(v => v.name).join(', '); vacHTML = `<div class="vacation-info">üèñÔ∏è Im Urlaub: ${names}</div>`; }
            let msg = st.color==='green' ? '‚úÖ Einsatzbereit' : `‚ö†Ô∏è Status: ${st.text}`;
            if(list.length===0) msg = "‚ö†Ô∏è Noch niemand eingeteilt";
            
            let card = document.createElement('div'); card.className = 'briefing-card';
            card.innerHTML = `
                <button class="copy-btn" onclick="copyStatus('${key}', '${title}', {count:${st.count}, color:'${st.color}', text:'${st.text}'}, ${JSON.stringify(list).replace(/"/g, "&quot;")})">üìã Copy</button>
                <div class="bc-head bc-${st.color}"><span>${title}, ${dateStr}</span><span>${st.count}/6</span></div><div class="bc-body"><div style="font-weight:bold; margin-bottom:5px;">${msg}</div>${notesHTML}${vacHTML}</div>`;
            board.appendChild(card);
        });
    }

    function toggleTimeInput(show) {
        document.getElementById('time-input-container').style.display = show ? 'flex' : 'none';
    }

    function openModal(key, day, st, list) {
        selectedKey = key;
        document.getElementById('modal-bg').style.display = 'flex';
        document.getElementById('m-date').innerText = day + ". " + document.getElementById('month-display').innerText;
        document.getElementById('m-status-text').innerText = st.text;
        
        let myEntry = list.find(x => x.name === currentUser.name);
        document.getElementById('m-note').value = myEntry ? myEntry.note : '';
        
        // Time Inputs setzen
        let isPart = myEntry && (myEntry.start !== '06:00' || myEntry.end !== '18:00');
        if(isPart) {
            document.querySelector('input[name="timeType"][value="part"]').checked = true;
            document.getElementById('time-input-container').style.display = 'flex';
            document.getElementById('t-start').value = myEntry.start;
            document.getElementById('t-end').value = myEntry.end;
        } else {
            document.querySelector('input[name="timeType"][value="full"]').checked = true;
            document.getElementById('time-input-container').style.display = 'none';
            document.getElementById('t-start').value = '06:00';
            document.getElementById('t-end').value = '18:00';
        }
        
        // Button Logik
        const btn = document.getElementById('btn-delete');
        if (myEntry) {
            btn.style.display = 'block';
        } else {
            btn.style.display = 'none';
        }

        let html = '';
        list.forEach(p => {
            let note = p.note ? `<br><span style="color:var(--primary); font-size:0.8rem;">‚û• ${p.note}</span>` : '';
            let badges = '';
            if(p.gf) badges += '<span class="badge badge-gf">GF</span>';
            if(p.c) badges += '<span class="badge badge-c">C</span>';
            if(p.pa) badges += '<span class="badge badge-pa">PA</span>';
            
            let timeBadge = '';
            // Zeige Zeit nur wenn nicht ganztags (06-18)
            if(p.start && p.end && (p.start !== '06:00' || p.end !== '18:00')) {
                timeBadge = `<span class="badge badge-time">üïí ${p.start}-${p.end}</span>`;
            }

            let highlight = (p.name === currentUser.name) ? "background:var(--bg-admin); border-left:3px solid var(--primary);" : "";
            html += `<div style="border-bottom:1px solid var(--border-color); padding:6px; ${highlight}"><b>${p.name}</b> ${badges} ${timeBadge} ${note}</div>`;
        });
        document.getElementById('m-list').innerHTML = html || '<i>Noch keine Anmeldungen</i>';
    }

    function saveEntry() {
        let list = entries[selectedKey] || [];
        let note = document.getElementById('m-note').value;
        
        let isFullDay = document.querySelector('input[name="timeType"]:checked').value === 'full';
        let s = isFullDay ? '06:00' : document.getElementById('t-start').value;
        let e = isFullDay ? '18:00' : document.getElementById('t-end').value;

        let idx = list.findIndex(x => x.name === currentUser.name);
        if(idx > -1) list.splice(idx, 1);
        
        list.push({...currentUser, note: note, start: s, end: e});
        
        entries[selectedKey] = list;
        document.getElementById('modal-bg').style.display = 'none';
        renderCalendar(); markUnsaved(); 
    }

    function deleteEntry() {
        if(!confirm("Austragen?")) return;
        let list = entries[selectedKey] || [];
        let idx = list.findIndex(x => x.name === currentUser.name);
        if(idx > -1) {
            list.splice(idx, 1);
            entries[selectedKey] = list;
            document.getElementById('modal-bg').style.display = 'none';
            renderCalendar(); markUnsaved();
        }
    }

    function closeModal(e) { if(e.target.id === 'modal-bg' || e.target.id === 'modal-vacation') { document.getElementById('modal-bg').style.display = 'none'; document.getElementById('modal-vacation').style.display = 'none'; }}
</script>
</body>
</html>
