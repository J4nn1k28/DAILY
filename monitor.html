<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Tagesdienst Dashboard</title>

    <link rel="icon" type="image/png" href="icon.png">
    <meta name="theme-color" content="#263238">

    <style>
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        
        :root {
            /* Monitor Theme: Dunkel & Kontrastreich für Screens */
            --bg-body: #263238; 
            --bg-card: #37474f; 
            --text-main: #eceff1;
            --text-muted: #b0bec5;
            --border-color: #455a64;

            --st-red-bg: #b71c1c; --st-red-txt: #ffcdd2; 
            --st-org-bg: #e65100; --st-org-txt: #ffe0b2; 
            --st-grn-bg: #1b5e20; --st-grn-txt: #c8e6c9; 
            --st-gry-bg: #455a64; --st-gry-txt: #78909c;

            --shadow: 0 4px 15px rgba(0,0,0,0.3);
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            margin: 0; padding: 0; background: var(--bg-body); color: var(--text-main);
            overflow-x: hidden; padding-bottom: 50px;
        }

        .container { max-width: 800px; margin: 0 auto; padding: 15px; }

        /* HEADER */
        .header { display: flex; justify-content: center; align-items: center; gap: 20px; margin-bottom: 20px; }
        .title { font-size: 1.8rem; font-weight: 800; margin: 0; color: #fff; }
        .btn-nav { background: none; border: none; color: white; font-size: 1.5rem; cursor: pointer; opacity: 0.7; }
        .btn-nav:hover { opacity: 1; }

        /* KALENDER GRID */
        .calendar-grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 8px; margin-bottom: 30px; }
        .weekday { text-align: center; font-size: 0.9rem; color: var(--text-muted); font-weight: 700; text-transform: uppercase; margin-bottom: 5px; }
        
        .day-cell {
            background: var(--bg-card); aspect-ratio: 1/1; border-radius: 12px; border: 1px solid var(--border-color);
            display: flex; flex-direction: column; justify-content: space-between; padding: 8px;
            box-shadow: var(--shadow); cursor: pointer; transition: transform 0.2s;
        }
        .day-cell:hover { transform: scale(1.02); z-index: 10; border-color: #fff; }
        
        .day-num { font-size: 1.1rem; font-weight: bold; color: var(--text-muted); }
        .day-count { align-self: center; font-size: 1.6rem; font-weight: 900; }
        
        /* STATUS FARBEN */
        .st-red { background: var(--st-red-bg); color: var(--st-red-txt); border: 1px solid #e57373; }
        .st-orange { background: var(--st-org-bg); color: var(--st-org-txt); border: 1px solid #ffb74d; }
        .st-green { background: var(--st-grn-bg); color: var(--st-grn-txt); border: 1px solid #81c784; }
        .st-past { opacity: 0.4; pointer-events: none; filter: grayscale(1); }

        /* LISTE UNTEN (DETAILS) */
        .detail-section h3 { border-bottom: 1px solid var(--border-color); padding-bottom: 10px; margin-top: 0; color: var(--text-muted); }
        .detail-card {
            background: var(--bg-card); border-radius: 12px; margin-bottom: 15px; overflow: hidden; 
            border: 1px solid var(--border-color); box-shadow: var(--shadow);
        }
        .dc-head { padding: 12px 20px; font-weight: bold; display: flex; justify-content: space-between; align-items: center; font-size: 1.1rem; }
        .dc-body { padding: 15px 20px; font-size: 1rem; line-height: 1.5; }
        
        .names-list { color: #fff; margin-top: 8px; }
        .missing-info { font-weight: bold; }
        
        .badge { font-size: 0.75rem; padding: 2px 6px; border-radius: 4px; margin: 0 2px; color: #000; font-weight: bold; vertical-align: middle; }
        .b-gf { background: #a5d6a7; } .b-c { background: #ffe082; } .b-pa { background: #ef9a9a; }

        /* MODAL */
        .modal-bg { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 100; display: none; align-items: center; justify-content: center; backdrop-filter: blur(5px); }
        .modal-card { background: var(--bg-card); width: 90%; max-width: 400px; border-radius: 15px; padding: 25px; border: 1px solid var(--border-color); box-shadow: 0 20px 50px rgba(0,0,0,0.5); }
        .modal-h { font-size: 1.5rem; font-weight: bold; margin-bottom: 5px; }
        .modal-sub { color: var(--text-muted); margin-bottom: 20px; }
        .modal-list div { padding: 8px 0; border-bottom: 1px solid var(--border-color); }
        .close-btn { width: 100%; padding: 12px; margin-top: 20px; background: #546e7a; color: white; border: none; border-radius: 8px; font-size: 1rem; cursor: pointer; }

        /* LOADING */
        #loading { position: fixed; top:0; left:0; width:100%; height:100%; background: var(--bg-body); display: flex; justify-content: center; align-items: center; z-index: 200; flex-direction: column; }
        .spinner { width: 50px; height: 50px; border: 5px solid #455a64; border-top-color: #fff; border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }

    </style>
</head>
<body>

<div id="loading"><div class="spinner"></div><p style="margin-top:15px; color:#fff;">Lade Monitor...</p></div>

<div class="container">
    <div class="header">
        <button class="btn-nav" onclick="changeWeek(-1)">&#9664;</button>
        <h1 class="title" id="month-display">Lade...</h1>
        <button class="btn-nav" onclick="changeWeek(1)">&#9654;</button>
    </div>

    <div class="calendar-grid">
        <div class="weekday">Mo</div><div class="weekday">Di</div><div class="weekday">Mi</div><div class="weekday">Do</div><div class="weekday">Fr</div>
        <div id="grid-content" style="display: contents;"></div>
    </div>

    <div class="detail-section">
        <h3>Vorschau (nächste 7 Tage)</h3>
        <div id="detail-list"></div>
    </div>
</div>

<div class="modal-bg" id="modal-bg" onclick="closeModal()">
    <div class="modal-card" onclick="event.stopPropagation()">
        <div class="modal-h" id="m-date">Datum</div>
        <div class="modal-sub" id="m-status">Status</div>
        <div id="m-list" class="modal-list"></div>
        <button class="close-btn" onclick="closeModal()">Schließen</button>
    </div>
</div>

<script>
    // ==========================================
    // CONFIG: HIER DEINE ID REIN!
    // ==========================================
    const PANTRY_ID = '647f62dc-1b66-48f1-a23c-976d635d236f';  // z.B. 945e-.....
    const BASKET_NAME = 'feuerwehr_data'; // Muss mit dem Basket-Namen übereinstimmen
    // ==========================================

    let entries = {};
    let weekOffset = 0;

    async function loadData() {
        try {
            if(PANTRY_ID.includes('HIER_')) throw new Error("ID fehlt");
            const res = await fetch(`https://getpantry.cloud/apiv1/pantry/${PANTRY_ID}/basket/${BASKET_NAME}`);
            const data = await res.json();
            entries = data.entries || {};
        } catch(e) {
            console.log("Fehler/Offline");
            entries = JSON.parse(localStorage.getItem('fw_entries')) || {};
        }
        document.getElementById('loading').style.display = 'none';
        render();
        
        // Auto-Refresh alle 5 Minuten für den Monitor
        setTimeout(loadData, 300000); 
    }

    function checkStatus(list) {
        list = list || [];
        let n = list.length;
        let pa = list.filter(x=>x.pa).length;
        let listGF = list.filter(x => x.gf);
        let listC = list.filter(x => x.c);
        let listBoth = list.filter(x => x.gf && x.c);
        let distinctHeads = listGF.length + listC.length - listBoth.length;

        let m = [];
        if(n<6) m.push((6-n)+" Pers");
        if(pa<2) m.push((2-pa)+" PA");
        if(listGF.length === 0) m.push("Führung");
        if(listC.length === 0) m.push("Masch.");
        if (listGF.length > 0 && listC.length > 0 && distinctHeads < 2) m.push("C/GF Konflikt");

        let col = 'green'; 
        if(m.length>0) col = 'orange'; 
        if(n<4) col = 'red';
        return { color: col, count: n, text: m.join(', ') || 'Vollzählig' };
    }

    function changeWeek(dir) { weekOffset += dir; render(); }

    function render() {
        const grid = document.getElementById('grid-content'); 
        grid.innerHTML = '';
        const now = new Date(); now.setHours(0,0,0,0);
        
        let dayOfWeek = now.getDay(); let dist = (dayOfWeek + 6) % 7; 
        let startMonday = new Date(now); 
        startMonday.setDate(now.getDate() - dist + (weekOffset * 7)); 

        document.getElementById('month-display').innerText = startMonday.toLocaleString('de-DE', {month:'long', year:'numeric'});

        // Grid rendern
        for(let w=0; w<2; w++) { 
            for(let d=0; d<5; d++) {
                let currentDay = new Date(startMonday);
                currentDay.setDate(startMonday.getDate() + (w * 7) + d);
                let key = currentDay.toLocaleDateString('en-CA');
                let list = entries[key] || [];
                let st = checkStatus(list);
                let isPast = currentDay < now;

                let el = document.createElement('div');
                let colorClass = isPast ? 'st-past' : `st-${st.color}`;
                el.className = `day-cell ${colorClass}`;
                el.onclick = () => openModal(key, currentDay, st, list);
                
                el.innerHTML = `
                    <div class="day-num">${currentDay.getDate()}</div>
                    <div class="day-count">${st.count}/6</div>
                `;
                grid.appendChild(el);
            }
        }

        // Details unten rendern (Immer ab HEUTE + 7 Tage, unabhängig vom Grid-Blättern)
        renderDetails(now);
    }

    function renderDetails(now) {
        const container = document.getElementById('detail-list');
        container.innerHTML = '';

        // Nächste 7 Tage anzeigen (ohne Wochenende)
        let daysShown = 0;
        let d = new Date(now);
        
        while(daysShown < 7) {
            if(d.getDay() !== 0 && d.getDay() !== 6) { // Mo-Fr
                let key = d.toLocaleDateString('en-CA');
                let list = entries[key] || [];
                let st = checkStatus(list);
                let dateStr = d.toLocaleDateString('de-DE', {weekday:'long', day:'2-digit', month:'2-digit'});
                
                // Namen formatieren
                let namesHTML = list.length > 0 
                    ? list.map(p => {
                        let b = '';
                        if(p.gf) b+='<span class="badge b-gf">GF</span>';
                        if(p.c) b+='<span class="badge b-c">C</span>';
                        if(p.pa) b+='<span class="badge b-pa">PA</span>';
                        return `${p.name}${b}`;
                      }).join(', ')
                    : '<span style="opacity:0.5">Keine Anmeldungen</span>';

                let missingHTML = st.color === 'green' ? '✅ Einsatzbereit' : `<span style="color:${st.color==='red'?'#ffcdd2':'#ffe0b2'}">⚠️ ${st.text}</span>`;

                container.innerHTML += `
                    <div class="detail-card">
                        <div class="dc-head st-${st.color}">
                            <span>${dateStr}</span>
                            <span>${st.count}/6</span>
                        </div>
                        <div class="dc-body">
                            <div class="missing-info">${missingHTML}</div>
                            <div class="names-list">${namesHTML}</div>
                        </div>
                    </div>`;
                
                daysShown++;
            }
            d.setDate(d.getDate() + 1);
        }
    }

    function openModal(key, dateObj, st, list) {
        document.getElementById('modal-bg').style.display = 'flex';
        document.getElementById('m-date').innerText = dateObj.toLocaleDateString('de-DE', {weekday:'long', day:'2-digit', month:'long'});
        document.getElementById('m-status').innerText = st.text;
        
        let html = '';
        if(list.length === 0) html = '<i>Niemand eingetragen</i>';
        else {
            list.forEach(p => {
                let note = p.note ? `<br><small style="color:#ffb74d">➥ ${p.note}</small>` : '';
                let b = '';
                if(p.gf) b+='<span class="badge b-gf">GF</span>';
                if(p.c) b+='<span class="badge b-c">C</span>';
                if(p.pa) b+='<span class="badge b-pa">PA</span>';
                html += `<div><b>${p.name}</b> ${b} ${note}</div>`;
            });
        }
        document.getElementById('m-list').innerHTML = html;
    }

    function closeModal() { document.getElementById('modal-bg').style.display = 'none'; }

    window.onload = loadData;
</script>
</body>
</html>